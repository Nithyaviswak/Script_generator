<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .ai-turn {
            background-color: #1f2937; 
            border-left: 4px solid #3b82f6; 
        }
        .user-turn {
            background-color: #1f2937; 
            border-left: 4px solid #8b5cf6; 
        }
        #storyDisplay::-webkit-scrollbar {
            width: 8px;
        }
        #storyDisplay::-webkit-scrollbar-track {
            background: #1f2937;
        }
        #storyDisplay::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
             background-color: #4b5563;
             color: white;
             transition: background-color 0.2s;
        }
        .btn-secondary:hover {
             background-color: #6b7280;
        }
        .input-field {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .disabled-ui {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="h-full antialiased">
    <div class="flex flex-col md:flex-row h-full">
        <!-- Main Story Area -->
        <main class="w-full md:w-2/3 lg:w-3/4 p-6 flex flex-col h-full">
            <header class="mb-4">
                <h1 class="text-3xl font-bold text-white">AI Story Room</h1>
                <p class="text-md text-gray-400">Your collaborative partner for stories and scripts.</p>
            </header>

            <!-- Setup Screen -->
            <div id="setupScreen" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-white">Start a New Story</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="genre" class="block text-sm font-medium text-gray-300">Genre</label>
                        <input type="text" id="genre" class="w-full p-2 mt-1 rounded-md input-field" placeholder="e.g., Sci-Fi, Fantasy, Mystery">
                    </div>
                    <div>
                        <label for="tone" class="block text-sm font-medium text-gray-300">Tone</label>
                        <input type="text" id="tone" class="w-full p-2 mt-1 rounded-md input-field" placeholder="e.g., Dark & Gritty, Humorous, Epic">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                         <label for="writingMode" class="block text-sm font-medium text-gray-300">Writing Mode</label>
                         <select id="writingMode" class="w-full p-2 mt-1 rounded-md input-field">
                             <option value="story">Story (Narrative Prose)</option>
                             <option value="script">Script (Screenplay Format)</option>
                         </select>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="firstEntry" class="block text-sm font-medium text-gray-300">Start the story with the first paragraph or scene:</label>
                    <textarea id="firstEntry" rows="4" class="w-full p-2 mt-1 rounded-md input-field" placeholder="In a city carved from starlight, a lone detective chased a memory..."></textarea>
                 </div>
                <button id="startButton" class="w-full mt-4 py-2 px-4 rounded-md font-semibold btn-primary">Begin Writing</button>
            </div>

            <!-- Writing Area -->
            <div id="writingScreen" class="hidden flex-grow flex flex-col">
                <div id="storyDisplay" class="flex-grow bg-gray-900 rounded-lg p-4 overflow-y-auto mb-4 border border-gray-700">
                    <!-- Story content will be injected here -->
                </div>
                <div id="userInputArea">
                    <textarea id="userEntry" rows="4" class="w-full p-3 rounded-md input-field" placeholder="Your turn. What happens next?"></textarea>
                    <button id="sendButton" class="w-full mt-2 py-2 px-4 rounded-md font-semibold btn-primary">Send to AI</button>
                    <div id="loadingIndicator" class="hidden mt-2 text-center">
                        <p class="text-blue-400">ðŸ¤– NarratorAI is thinking...</p>
                    </div>
                </div>
            </div>

            <footer class="text-center pt-4 mt-auto text-xs text-gray-600">
                <p>R NITHYANANDACHARI &bull; nviswaks@gmail.com</p>
                <div class="flex justify-center space-x-4 mt-2">
                    <a href=https://www.linkedin.com/in/nithya-nanda-b01964294?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="LinkedIn Profile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                    </a>
                    <a href=https://github.com/Nithyaviswak target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="GitHub Profile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    </a>
                </div>
            </footer>
        </main>

        <!-- Sidebar / Character Bible -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-gray-900 p-6 border-l border-gray-700 flex flex-col h-full">
            <h2 class="text-2xl font-bold mb-4 text-white">Character Bible</h2>
            <div id="characterList" class="flex-grow overflow-y-auto pr-2">
                <!-- Character cards will be injected here -->
                 <p class="text-gray-500 italic">No characters defined yet. Add one below.</p>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <h3 class="text-lg font-semibold mb-2 text-white">Add/Update Character</h3>
                <input type="text" id="charName" class="w-full p-2 mb-2 rounded-md input-field" placeholder="Character Name">
                <textarea id="charDesc" rows="3" class="w-full p-2 mb-2 rounded-md input-field" placeholder="Character Description, Traits, Goals..."></textarea>
                <button id="addCharButton" class="w-full py-2 px-4 rounded-md font-semibold btn-secondary">Add Character</button>
            </div>
        </aside>
    </div>

    <script>
        
        const setupScreen = document.getElementById('setupScreen');
        const writingScreen = document.getElementById('writingScreen');
        const startButton = document.getElementById('startButton');
        const storyDisplay = document.getElementById('storyDisplay');
        const userEntry = document.getElementById('userEntry');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const characterList = document.getElementById('characterList');
        const charNameInput = document.getElementById('charName');
        const charDescInput = document.getElementById('charDesc');
        const addCharButton = document.getElementById('addCharButton');
        
       
        let storyState = {
            genre: '',
            tone: '',
            writingMode: 'story',
            history: [],
            characterBible: {}
        };

       
        startButton.addEventListener('click', startGame);
        sendButton.addEventListener('click', handleUserTurn);
        addCharButton.addEventListener('click', handleAddCharacter);
        userEntry.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserTurn();
            }
        });

       
        function startGame() {
            const genre = document.getElementById('genre').value.trim();
            const tone = document.getElementById('tone').value.trim();
            const firstEntry = document.getElementById('firstEntry').value.trim();
            const writingMode = document.getElementById('writingMode').value;
            
            if (!genre || !tone || !firstEntry) {
                alert('Please fill out all setup fields to begin.');
                return;
            }

            storyState.genre = genre;
            storyState.tone = tone;
            storyState.writingMode = writingMode;
            
            addTurnToStory('user', firstEntry);
            
            setupScreen.classList.add('hidden');
            writingScreen.classList.remove('hidden');
            
            getAIContribution(firstEntry);
        }
        
        function handleUserTurn() {
            const entry = userEntry.value.trim();
            if (!entry) return;

            addTurnToStory('user', entry);
            userEntry.value = '';
            
            getAIContribution(entry);
        }

        function handleAddCharacter() {
            const name = charNameInput.value.trim();
            const desc = charDescInput.value.trim();

            if (!name || !desc) {
                alert('Please provide both a name and description for the character.');
                return;
            }

            storyState.characterBible[name] = desc;
            charNameInput.value = '';
            charDescInput.value = '';
            renderCharacterBible();
        }

        function renderCharacterBible() {
            if (Object.keys(storyState.characterBible).length === 0) {
                characterList.innerHTML = '<p class="text-gray-500 italic">No characters defined yet. Add one below.</p>';
                return;
            }
            
            characterList.innerHTML = '';
            for (const [name, desc] of Object.entries(storyState.characterBible)) {
                const charCard = document.createElement('div');
                charCard.className = 'bg-gray-800 p-3 rounded-md mb-2';
                charCard.innerHTML = `
                    <h4 class="font-bold text-white">${name}</h4>
                    <p class="text-sm text-gray-400">${desc}</p>
                `;
                characterList.appendChild(charCard);
            }
        }
        
        function addTurnToStory(author, text) {
            storyState.history.push({ author, text });
            
            const turnDiv = document.createElement('div');
            turnDiv.className = `p-4 rounded-lg mb-4 ${author === 'user' ? 'user-turn' : 'ai-turn'}`;
            
            const authorTag = document.createElement('p');
            authorTag.className = 'font-semibold text-sm mb-1';
            authorTag.textContent = author === 'user' ? 'You' : 'NarratorAI';
            
            const textContent = document.createElement('div');
            
            textContent.innerHTML = `<pre class="whitespace-pre-wrap font-sans">${text}</pre>`;

            turnDiv.appendChild(authorTag);
            turnDiv.appendChild(textContent);
            storyDisplay.appendChild(turnDiv);
            
            
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
        }

        function formatCharacterSheet(bible) {
            if (Object.keys(bible).length === 0) return "No characters defined yet.";
            return Object.entries(bible)
                .map(([name, desc]) => `- ${name}: ${desc}`)
                .join('\n');
        }

        function toggleUI(enabled) {
            const uiArea = document.getElementById('userInputArea');
            if (enabled) {
                loadingIndicator.classList.add('hidden');
                uiArea.classList.remove('disabled-ui');
                userEntry.focus();
            } else {
                loadingIndicator.classList.remove('hidden');
                uiArea.classList.add('disabled-ui');
            }
        }
        
        async function getAIContribution(userInput) {
            toggleUI(false);
            
            const currentStoryText = storyState.history.map(turn => `${turn.author === 'user' ? 'Lead Author' : 'NarratorAI'}: ${turn.text}`).join('\n\n');

            let rules, response_type;
            if (storyState.writingMode === "script") {
                rules = `**Screenwriting Rules:**\n- You must follow standard screenplay format.\n- **Scene Headings:** Use INT. or EXT. followed by location and time.\n- **Character Cues:** Character names in ALL CAPS.\n- **Action Lines:** Describe actions in the present tense.`;
                response_type = "next part of the script";
            } else {
                rules = `**Story Writing Rules:**\n- Write in a narrative, paragraph-based format.\n- Weave in descriptive language and character emotions.\n- Keep your response to a single, well-developed paragraph.`;
                response_type = "next paragraph of the story";
            }
            
            const prompt = `
You are "NarratorAI," an expert co-writer. Your purpose is to help me, the Lead Author, write a compelling narrative.

**Core Directives:**
1. Adhere to the established Genre and Tone.
2. Maintain consistency with the plot and characters.
3. Be collaborative. Build upon my ideas, don't take over.
4. Respond with Narrative Only. Do not add commentary.

${rules}

---
[STORY SETUP]
Genre: ${storyState.genre}
Tone: ${storyState.tone}
Mode: ${storyState.writingMode}

[CHARACTER BIBLE]
${formatCharacterSheet(storyState.characterBible)}

[STORY SO FAR]
${currentStoryText}

[LEAD AUTHOR'S LATEST ENTRY]
${userInput}
---

Based on all the information above, write the ${response_type} now:`;
            
            try {
                // Ollama's default endpoint
                const response = await fetch('http://localhost:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'llama3:8b', // Make sure you have this model
                        stream: false, // For simplicity, we get the whole response at once
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Ollama API error: ${response.statusText}`);
                }

                const data = await response.json();
                const aiText = data.message.content;
                addTurnToStory('ai', aiText);

            } catch (error) {
                console.error("Error fetching from Ollama:", error);
                const errorMessage = `ðŸš¨ **Error connecting to Ollama.**\nIs the Ollama server running on your machine?\n\nDetails: ${error.message}`;
                addTurnToStory('ai', errorMessage);
            } finally {
                toggleUI(true);
            }
        }
    </script>
</body>
</html>


